<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>DCI Openshift App Agent :: Jose Gato Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="DCI Agents helps you to run any kind of test or application in a Openshift existing deployment." />
<meta name="keywords" content=", " />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://jgato.github.io/jgato/posts/dci/" />




<link rel="stylesheet" href="https://jgato.github.io/jgato/assets/style.css">

  <link rel="stylesheet" href="https://jgato.github.io/jgato/assets/red.css">






<link rel="apple-touch-icon" href="https://jgato.github.io/jgato/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://jgato.github.io/jgato/img/favicon/red.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="jgatoluis" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="DCI Openshift App Agent">
<meta property="og:description" content="DCI Agents helps you to run any kind of test or application in a Openshift existing deployment." />
<meta property="og:url" content="https://jgato.github.io/jgato/posts/dci/" />
<meta property="og:site_name" content="Jose Gato Blog" />

  <meta property="og:image" content="https://jgato.github.io/jgato/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-09-16 11:19:12 &#43;0200 CEST" />












</head>
<body class="red">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://jgato.github.io/jgato/posts/dci/">DCI Openshift App Agent</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-09-16
        
      </span>
    
    
      <span class="post-author">:: Jose Gato Luis</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://jgato.github.io/jgato/tags/openshift/">openshift</a>&nbsp;
    
    #<a href="https://jgato.github.io/jgato/tags/dci/">dci</a>&nbsp;
    
    #<a href="https://jgato.github.io/jgato/tags/automation/">automation</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <h1 id="dci-openshift-app-agent">DCI Openshift App Agent<a href="#dci-openshift-app-agent" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This DCI Agents helps you to run any kind of test or application in a Openshift existing deployment.</p>
<p>Where to run it? In you usual provisioner, bastion, or supporting host to manage your Openshift Cluster. <em>During the ramp-up, usually we can use the lab-installer from our plan deployment</em>.</p>
<p>Requirements for the provisioner:</p>
<ul>
<li>
<p>Be running the latest stable RHEL release (<strong>8.4 or higher</strong>) and registered via RHSM</p>
<ul>
<li>I have tested with CentOS and it works ok</li>
</ul>
</li>
<li>
<p>Ansible 2.9 (See section Newer Ansible Versions for newer Ansible versions)</p>
</li>
<li>
<p>Access to the Internet, it could be through a proxy. Check our lab config to configure the proxy.</p>
</li>
<li>
<p>Access to the following repositories:</p>
<ul>
<li>epel</li>
<li>dci-release</li>
<li>baseos-rpms</li>
<li>appstream-rpms</li>
</ul>
</li>
<li>
<p>Podman 3.0</p>
</li>
<li>
<p>kubernetes python module</p>
</li>
</ul>
<p>If you created your provisioner with a kcli plan, mostly all of these requirement are already ok. Even the proxy configuration. So you only have to install the following in your provisioner (or lab-installer) host:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
</span></span><span style="display:flex;"><span>dnf -y install https://packages.distributed-ci.io/dci-release.el8.noarch.rpm
</span></span><span style="display:flex;"><span>dnf -y install python3-kubernetes
</span></span><span style="display:flex;"><span>dnf -y install dci-openshift-app-agent
</span></span></code></pre></div><h2 id="dci-console-and-remote-cis">DCI Console and remote CIS<a href="#dci-console-and-remote-cis" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><a href="https://www.distributed-ci.io/">Visit the DCI Console</a> to create your new remote CIS that will be used by the agent.</p>
<p><img src="./assets/2021-11-26-13-47-49-image.png" alt=""></p>
<p>Once it is created take your credentials information.</p>
<h2 id="configure-agent-credentials">Configure Agent credentials<a href="#configure-agent-credentials" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Edit the file &lsquo;/etc/dci-openshift-app-agent/dcirc.sh&rsquo; with your new credentials</p>
<pre tabindex="0"><code>#!/usr/bin/env bash
DCI_CS_URL=&#34;https://api.distributed-ci.io/&#34;
DCI_CLIENT_ID=remoteci/&lt;remoteci_id&gt;
DCI_API_SECRET=&lt;remoteci_api_secret&gt;
export DCI_CLIENT_ID
export DCI_API_SECRET
export DCI_CS_URL
</code></pre><h2 id="running-tests">Running tests<a href="#running-tests" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>You will need access to the KUBECONFIG from the user &lsquo;dci-openshift-app-agent&rsquo;. This will depend on your installation, but something like:</p>
<pre tabindex="0"><code># mkdir /var/lib/dci-openshift-app-agent/.kube
# cp /root/ocp/auth/kubeconfig /var/lib/dci-openshift-app-agent/.kube/config
# chown -R dci-openshift-app-agent: /var/lib/dci-openshift-app-agent/.kube
# su - dci-openshift-app-agent
</code></pre><p>And run the agent manually:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>su - dci-openshift-app-agent
</span></span><span style="display:flex;"><span>dci-openshift-app-agent-ctl -s
</span></span></code></pre></div><p>The first time you run it, it will fail. This is on purpose to make you understand how it works. You can just add (empty) missing files or skip the steps.</p>
<p>The agent will run  tags (from a job, like steps to accomplish a job) for a set of configured tests. Possible tags: <code>job</code>, <code>dci</code>, <code>kubeconfig</code>, <code>pre-run</code>, <code>redhat-pre-run</code>, <code>partner-pre-run</code>, <code>install</code>, <code>running</code>, <code>testing</code>, <code>redhat-testing</code>, <code>partner-testing</code>, <code>post-run</code>, <code>succes</code></p>
<p>The main entry point when running jobs is the file <code>/usr/share/dci-openshift-app-agent/dci-openshift-app-agent.yml</code> which defines what to do depending on the selected tags. A little exmple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Step 2 : &#34;running&#34; step</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Execute install step&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">jumphost</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">install</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">running</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">KUBECONFIG</span>: <span style="color:#e6db74">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set job state - running</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">dci_job</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">id</span>: <span style="color:#e6db74">&#34;{{ job_id }}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">status</span>: <span style="color:#e6db74">&#34;running&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tags</span>: [<span style="color:#ae81ff">dci]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Execute install play&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_tasks</span>: <span style="color:#e6db74">&#39;plays/install.yml&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Execute install hook&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_tasks</span>: <span style="color:#e6db74">&#34;{{ dci_config_dir }}/hooks/install.yml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rescue</span>: <span style="color:#75715e">&amp;failure_with_upload_logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Execute the teardown process&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_tasks</span>: <span style="color:#e6db74">&#34;{{ dci_config_dir }}/hooks/teardown.yml&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">when</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">dci_teardown_on_failure</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">check_teardown.stat.exists</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Execute the failure process&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">include_tasks</span>: <span style="color:#ae81ff">plays/failure.yml</span>
</span></span></code></pre></div><p>This step is making use of a hook install.yml and teardown.yml</p>
<p>By default the hooks are stored in <code>/etc/dci-openshift-app-agent/hooks/</code> with an structure like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>├── hooks
</span></span><span style="display:flex;"><span>│   ├── pre-run.yml
</span></span><span style="display:flex;"><span>│   ├── install.yml
</span></span><span style="display:flex;"><span>│   ├── tests.yml
</span></span><span style="display:flex;"><span>│   ├── post-run.yml
</span></span><span style="display:flex;"><span>│   └── teardown.yml
</span></span></code></pre></div><p>But you can create your own hooks directory.</p>
<h2 id="running-your-own-tests">Running your own tests<a href="#running-your-own-tests" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>The installation comes with some example jobs in <code>/var/lib/dci-openshift-app-agent/samples/</code>.</p>
<p>You can edit <code>/etc/dci-openshift-app-agent/settings.ym</code> to point to the configuration directory of some of these example.</p>
<p>Or you can create whatever other settings file and run the agent with -c FILE_WITH_ABSOLUTE_PATH.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">dci_topic</span>: <span style="color:#ae81ff">OCP-4.9</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_components_by_query</span>: [<span style="color:#e6db74">&#39;name:4.9.7&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_comment</span>: <span style="color:#e6db74">&#34;Test webserver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_openshift_app_ns</span>: <span style="color:#ae81ff">testns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_config_dir</span>: <span style="color:#ae81ff">/var/lib/dci-openshift-app-agent/samples/basic_example</span>
</span></span></code></pre></div><p>This example it just create a webserver, test it works and delete it.</p>
<ul>
<li>
<p>dci_topic: where are testing OCP 4.9</p>
</li>
<li>
<p>dci_components_by_query:  A component is an artifact (file, package, url, etc.) attached to a topic. An agent take components in its workflow. Those components are immutable and regularly updated with newer versions of the artifact through a feeder.</p>
</li>
<li>
<p>dci_comment: just a message that can be used to know what the test did.</p>
</li>
<li>
<p>dci_openshift_app_ns: the namespace where the different K8S will be created/testeed/deleted</p>
</li>
<li>
<p>dci_config_dir: the directory with the hooks for the tests</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dci-openshift-app-agent-ctl -s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>dci-openshift-app-agent-ctl -s -c NEW_CONFIG_FILE
</span></span></code></pre></div><p>When everything is finished you can see the resoults in the output and in the web console:</p>
<h2 id="running-cnf-tests">Running CNF tests<a href="#running-cnf-tests" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Some special tests we will have to manage are about CNF testes. The settings.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">dci_topic</span>: <span style="color:#ae81ff">OCP-4.8</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_components_by_query</span>: [<span style="color:#e6db74">&#39;name:4.8.13&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_comment</span>: <span style="color:#e6db74">&#34;Test CNF suite&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_openshift_app_ns</span>: <span style="color:#ae81ff">testns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_config_dir</span>: <span style="color:#ae81ff">/var/lib/dci-openshift-app-agent/samples/tnf_test_example</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dci_openshift_app_image</span>: <span style="color:#ae81ff">quay.io/testnetworkfunction/cnf-test-partner:latest</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tnf_suites</span>: <span style="color:#e6db74">&#34;diagnostic access-control networking lifecycle observability platform-alteration&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tnf_targetpodlabels</span>: [<span style="color:#ae81ff">test-network-function/environment=testing]s</span>
</span></span></code></pre></div><p>This test will use a discovery mechanisms based on tags. So you have to tag properly your nodes, something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#e6db74">`</span>seq <span style="color:#ae81ff">0</span> 2<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>&gt; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>&gt; oc label node lab-master-$i role<span style="color:#f92672">=</span>partner
</span></span><span style="display:flex;"><span>&gt; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>But it would depend on your installation.</p>
<p>The output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PLAY RECAP *******************************************************************************************************************
</span></span><span style="display:flex;"><span>jumphost                   : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">70</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>   rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>This is how you see it from the web console</p>
<p><img src="./assets/2021-11-26-11-51-17-image.png" alt=""></p>
<h1 id="dci-openshift-agent">DCI Openshift Agent<a href="#dci-openshift-agent" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p><strong>Notice: DCI Openshift Agent is related to install/test/update OCP4 installation, and it is not covered in this tutorial</strong></p>
<p>DCI agent for OCP4 will be in charge of automatic CI process over your cluster. DCI, aims to automatically deploy and test RedHat Products (like new versions of OCP). The DCI Openshift Agent is in charge of deploying OCP4.</p>
<p>What?: Using this agent you can deploy and test new updates of OCP4.</p>
<p>Who?: Red Hat deployments, but also partners.</p>
<p>Why? To test OCP in your own hardware and configuratoin. Partners? This allows them to also test their products and solutions installed in OCP4. This facilitates his certification of products making tests previous to a new release, and be prepared for that.</p>
<p>Other advantes:</p>
<ol>
<li>Automation of nightly/candidate OCP component testing</li>
<li>CI runs on your own hardware</li>
<li>Red Hat doesn&rsquo;t have access to your hardware, the agent reports metrics/logs
back to distributed-ci.io</li>
<li>The agent leverages the OpenShift IPI Installer which in turn is based on
proven ansible tech</li>
<li>You have access to all your jobs logs and metrics through distributed-ci.io
where you can also set notifications for errors/exceptions</li>
</ol>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="https://jgato.github.io/jgato/posts/ipv6/">
                <span class="button__text">Just a little of IPv6 </span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://jgato.github.io/jgato/assets/main.js"></script>
<script src="https://jgato.github.io/jgato/assets/prism.js"></script>







  
</div>

</body>
</html>
